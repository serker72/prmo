<script type="text/javascript" src="/js/gen_validatorv4.js"></script>
<script type="text/javascript" src="/js/touch.js"></script>
<script type="text/javascript" src="/js/period_checker.js"></script>
%{include file="unavailable_dates.html}%
<script type="text/javascript">
var was_changed=false;
$(function(){
$.datepicker.setDefaults($.extend($.datepicker.regional['ru']));
	$("#pdate").datepicker({changeMonth: true, changeYear:true, yearRange: '2012:+15'});
	$("#given_pdate").datepicker({changeMonth: true, changeYear:true, yearRange: '2012:+15'});
	
	
	$.each($("#crea_form input"), function(key, value){
	 	$(value).bind("change",function(){
			was_changed=was_changed||true;
		});
	});
	
	$.each($("#crea_form select"), function(key, value){
	 	$(value).bind("change",function(){
			was_changed=was_changed||true;
		});
	});
	
	$.each($("#crea_form textarea"), function(key, value){
	 	$(value).bind("change",function(){
			was_changed=was_changed||true;
		});
	});
	
	touchScroll('org_bdetails');
	touchScroll('bdetails');
	touchScroll('suppliers');
	touchScroll('notes');
});
</script>




<form action="ed_pay.php" method="post" id="crea_form">
<input type="hidden" name="action" value="1" />
<input type="hidden" id="id"  name="id" value="%{$ship.id}%" />
<input type="hidden" name="current_status_id" value="%{$ship.status_id}%" />

<input type="hidden" name="bill_id" id="bill_id" value="%{$ship.bill_id}%" />
<input type="hidden" id="org_id"    value="%{$org_id}%" />

<input type="hidden" id="current_user_id"    value="%{$current_user_id}%" />

<div style="float:left; margin-right:20px;">
<h1 style="">Редактирование исходящей оплаты</h1>
</div>

%{include file="every_help_dialog.html" filename="pay_edit.htm;pay_md.html;pay_return.html;pay_inner.html" prefix="" description="редактирование исходящей оплаты"  style="float:right;  padding-top:10px;  margin-right:00px;"  is_right=true}%

<div style="float:right; padding-top:10px; margin-right:10px;   text-align:right;">
 
<input type="button" value="Файлы..." onclick="location.href='pay_files.php?pay_id=%{$ship.id}%';" style="width:70px;" />

</div>

<div style="float:right; padding-top:10px; margin-right:10px;   text-align:right;">

%{if $ship.is_confirmed==1}%
 %{if $can_print}%
 <a href="ed_pay.php?action=1&id=%{$ship.id}%&print=1" target="_blank" class="reestr_print reestr_right_button24" data-comment="печать исходящей оплаты..."  ></a>
 %{else}%
  <a href="#" onclick="alert('У Вас недостаточно прав для печати исходящей оплаты.'); return false;" class="reestr_print reestr_inactive reestr_right_button24" data-comment="печать исходящей оплаты..."></a>
 %{/if}%
 
 %{else}%
 <a href="#" onclick="alert('В данном режиме печать исходящей оплаты недоступна. Пожалуйста, утвердите исходящую оплату.'); return false;" class="reestr_print reestr_inactive reestr_right_button24" data-comment="печать исходящей оплаты..."></a>
 %{/if}%



 
 
</div>




<br clear="all" />

<div style="float:left; margin-right:20px;">
<strong>Код:</strong><br />

%{$ship.code}%
</div>


<div style="float:left; margin-right:20px; max-width:100px;">
<strong>Дата создания:</strong><br />

%{$ship.pdate}%<br />
<small>создана: %{$created_by}%</small>
</div>

<div style="float:left; margin-right:20px;">
<label for="given_no">Заданный номер:</label><br />

<input type="text" size="10" maxlength="255" value="%{$ship.given_no}%" name="given_no" id="given_no" %{if !$can_modify}% disabled="disabled"%{/if}% />
</div>

<div style="float:left; margin-right:10px;">
<label for="given_pdate">Заданная дата:</label><br />

<input type="text" size="10" maxlength="10" name="given_pdate" id="given_pdate" value="%{$ship.given_pdate}%"  %{if !$can_modify}% disabled="disabled"%{/if}% style="width:60px;" />
</div>

<div style="float:left; margin-right:20px;">
<label for="value">Сумма платежа, руб.:</label><br />

<input type="text" size="20" maxlength="255" value="%{$ship.value}%" name="value" id="value" %{if !$can_modify}% disabled="disabled"%{/if}% />
</div>

<div style="float:left; margin-right:20px;">
<label for="">Организация:</label><br />

<input type="text" size="30" maxlength="255" value="%{$org}%" disabled="disabled" />
</div>


<div style="float:right; margin-right:0px; margin-top:-5px; min-width:120px;" id="toggle_annul">
%{include file="pay/toggle_annul_card.html"}%
</div>



<br clear="all" />
<p />



<div style="float:left; margin-right:0px;">
<label for="bdetails_id">

Реквизиты организации:</label><br />


<input type="text" size="40" maxlength="255" id="org_bdetails_id_string" value="%{$ship.org_bdetails_id_string|escape}%" disabled="disabled" style="width:670px;"  />
<input type="hidden" name="org_bdetails_id" id="org_bdetails_id" value="%{$ship.org_bdetails_id}%" />
<input type="button" id="org_bdetails_select" value="..." %{if !$can_modify}% disabled="disabled"%{/if}% />
<input type="button" id="org_bdetails_clear" value="x" %{if !$can_modify}% disabled="disabled"%{/if}% />

</div>
<br clear="all" />
<p />

%{include file="pay/org_actions.html"}%






<!-- блок выбора кода оплаты -->

<div style="float:left; margin-right:20px;">
<label for="code_id">

Код оплаты:</label><br />


<input type="text" size="40" maxlength="255" id="code_id_string" value="%{$ship.code_id_string|escape}%" disabled="disabled" style="width:398px;"  />
<input type="hidden" name="code_id" id="code_id" value="%{$ship.code_id}%" />
<input type="button" id="code_select" value="..." %{if !$can_modify}% disabled="disabled"%{/if}% />
<input type="button" id="code_clear" value="x" %{if !$can_modify}% disabled="disabled"%{/if}% />

</div>

 

%{include file="pay/code_actions.html"}%

<!-- конец блока выбора кода оплаты -->







<div style="float:left; margin-right:20px;"><br />

<input type="checkbox" id="is_inner_pay" name="is_inner_pay" value="1" %{if $ship.is_inner_pay==1}% checked="checked"%{/if}% %{if !$can_modify}% disabled="disabled"%{/if}%   /><label for="is_inner_pay">Внутренний платеж</label>
<script type="text/javascript">
$(function(){
	$("#is_inner_pay").bind("change", function(){
		if($("#is_inner_pay").prop("checked")){
			$("#inner_user_id_block").show();
			$("#is_return").prop("checked", false);
			$("#is_return").trigger("change");
			$("#inner_user_id").val($("#current_user_id").val());	
			$("#supplier_clear").trigger("click");	
		}else{
			$("#inner_user_id_block").hide();
			$("#inner_user_id").val(0);
			
		}
	});
	$("#inner_user_id").bind("change", function(){
		if(($("#inner_user_id").val()!=0)&&($("#inner_user_id").val()!=undefined)){
			$("#supplier_clear").trigger("click");	
		}
	});
});
</script>
</div>




<div style="float:left; margin-right:10px; margin-top:13px;">
<input type="checkbox" value="1" name="is_return" id="is_return" %{if !$can_modify}% disabled="disabled"%{/if}% %{if $ship.is_return==1}% checked="checked"%{/if}% /><label for="is_return">Возврат д/с</label>
</div>
<script type="text/javascript">
$(function(){
	$("#is_return").bind("change", function(){
		if($("#is_return").prop("checked")){
			$("#is_inner_pay").prop("checked",false);
			$("#is_inner_pay").trigger("change");
			
			
	//подгрузить код 59
					 $.ajax({
						async: true,
						url: "/js/pay.php",
						type: "GET",
						dataType: "json",
						data:{
							"action":"retrieve_code",
							"id":59
						},
						beforeSend: function(){
						  
						},
						success: function(data){
						  
						  $("#code_id_string").attr("value",''+data.code+' '+data.name+' '+data.descr);
						  $("#code_id").attr("value",data.id);
						  
						},
						error: function(xhr, status,m){
						    
						   //alert("Ошибка выбора кода оплаты."+status+m);
						}	 
					  });
		}
	});
});
</script>



<br clear="all" />
<p />

<div id="inner_user_id_block" %{if $ship.is_inner_pay==0}% style="display:none;"%{/if}%>
<div style="float:left; margin-right:20px;">
	<label for="inner_user_id">Сотрудник-получатель:</label><br />
	<select id="inner_user_id" name="inner_user_id" style="width:400px" %{if !$can_modify}% disabled="disabled"%{/if}% >
    %{html_options values=$inner_user_id_ids selected=$ship.inner_user_id output=$inner_user_id_vals}%
    </select>

</div>
<br clear="all" />
<p />
</div>







<div style="float:left; margin-right:20px;">


<label for="supplier_id">
Контрагент:</label><br />


<input type="text" size="40" maxlength="255" id="supplier_id_string" disabled="disabled" style="width:398px;" value="%{$ship.supplier_id_string}%" />
<input type="button" id="supplier_select" value="..." %{if !$can_modify}% disabled="disabled"%{/if}% />
<input type="button" id="supplier_clear" value="x" %{if !$can_modify}% disabled="disabled"%{/if}% />

<input type="hidden"  value="%{$ship.supplier_id}%" name="supplier_id" id="supplier_id" />
</div>



<div style="float:left; margin-right:10px;">

<label for="contract_no">Договор №:</label>
<br />

<input type="text" size="10" maxlength="255" value="%{$ship.contract_no}%" id="contract_no_string" disabled="disabled" style="width:100px;" />

<input type="hidden"  value="%{$ship.contract_id}%" name="contract_id" id="contract_id" %{if !$can_modify}% disabled="disabled"%{/if}% />
</div>

<div style="float:left; margin-right:5px;">
<label for="contract_pdate">от:</label><br />

<input type="text" size="10" maxlength="255" value="%{$ship.contract_pdate}%" id="contract_pdate_string" disabled="disabled" style="width:60px;" %{if !$can_modify}% disabled="disabled"%{/if}% />
<input type="hidden" name="contract_pdate" id="contract_pdate" value="%{$ship.contract_pdate}%" %{if !$can_modify}% disabled="disabled"%{/if}% />

</div>


<div style="float:left; margin-right:10px; margin-top:13px;">


<input type="button" id="contract_select" value="..." %{if !$can_modify}% disabled="disabled"%{/if}%  />
<input type="button" id="contract_clear" value="x" %{if !$can_modify}% disabled="disabled"%{/if}%  />

</div>




<br clear="all" />
<p />


<div style="float:left; margin-right:0px;">
<label for="bdetails_id">

Реквизиты контрагента:</label><br />


<input type="text" size="40" maxlength="255" id="bdetails_id_string" value="%{$ship.bdetails_id_string|escape}%" disabled="disabled" style="width:670px;"  />
<input type="hidden" name="bdetails_id" id="bdetails_id" value="%{$ship.supplier_bdetails_id}%" />
<input type="button" id="bdetails_select" value="..." %{if !$can_modify}% disabled="disabled"%{/if}% />
<input type="button" id="bdetails_clear" value="x" %{if !$can_modify}% disabled="disabled"%{/if}% />

</div>

<br clear="all" />
<p />

%{include file="pay/supplier_actions.html" action=1}%







<div style="float:left; margin-right:20px;">
<input name="pay_for_dogovor" id="pay_for_dogovor" type="checkbox" value="1" %{if $ship.pay_for_dogovor==1}% checked="checked"%{/if}% %{if !$can_modify or !$can_add_positions  or $ship.supplier_id==$org_id}% disabled="disabled"%{/if}% />
<label for="pay_for_dogovor">Оплата по договору</label>


</div>
%{include file="pay/pay_for_dogovor_actions.html"}%

<div style="float:left; margin-right:20px;">
<input name="pay_for_bill" id="pay_for_bill" type="checkbox" value="1" %{if $ship.pay_for_bill==1}% checked="checked"%{/if}% %{if !$can_modify or !$can_add_positions or $ship.supplier_id==$org_id}% disabled="disabled"%{/if}% />
<label for="pay_for_bill">Оплата по счету</label>


</div>
%{include file="pay/pay_for_bill_actions.html"}%


<br clear="all" />
<p />



<strong>Сделка:</strong>
<input type="button" id="add_pos" value="Выбрать счета..." %{if !$can_modify or !$can_add_positions  or $ship.supplier_id==$org_id}% disabled="disabled"%{/if}% />


<br />



<div id="nested_bills">
 <input type="hidden" id="sort_mode" value="0" />
%{include file="pay/bills_actions.html" action=1}%
</div>


<h4>Примечания:</h4>
<div id="notes" style="border:1px solid silver; width:100%; height:100px; overflow:auto;">
        %{include file="pay/d_notes.html" items=$notes word="notes" named="Примечания" user_id=$ship.id can_edit=$can_notes_edit}%
    </div>
    %{if $can_notes_edit}%
    %{include file="pay/d_notes_dialog.html" word="notes" named="Примечания" user_id=$ship.id can_edit=$can_notes_edit}%
    %{/if}%
<p />    




<div style="float:left; margin-right:20px;">
<input type="checkbox" name="is_confirmed" id="is_confirmed" value="1" onchange="" %{if $ship.is_confirmed==1}% checked="checked"%{/if}% %{if $can_confirm==false}% disabled="disabled"%{/if}% /><label for="is_confirmed">Утверждаю</label>
<span id="is_confirmed_confirmer">%{$is_confirmed_confirmer}%</span>


<script type="text/javascript">
$(function(){
	$("#is_confirmed").bind("click",function(){
		if(	this.checked) state=1;
		else state=0;
		
		$.ajax({
              async: true,
              url: "/js/pay.php",
              type: "POST",
              data:{
                  "action":"redraw_is_confirmed_confirmer",
				  state: state
              },
              beforeSend: function(){
                 $("#is_confirmed_confirmer").html('<img src="/img/icon_wait.gif" width="16" height="16" alt="подождите, пожалуйста..." border="0" />');   
              },
              success: function(data){
               
				$("#is_confirmed_confirmer").html(data);
                
              },
              error: function(xhr, status){
                  //alert("Ошибка добавления вопроса.");	
              }	 
          });
		
		
	});
});
</script>

</div>
<br clear="all" />
<p />



%{if $can_edit}%
<input type="submit" name="doEdit" id="doEdit" value="Сохранить и перейти к %{if $bill_id>0}%входящему счету%{else}%реестру исходящих оплат%{/if}%" />
<input type="submit" name="doEditStay" id="doEditStay" value="Сохранить и остаться" />
%{/if}%

<input type="button" id="do_close" value="Закрыть форму" onclick="if(was_changed){
if(window.confirm('Вы уверены, что хотите закрыть форму? Все несохраненные изменения будут утрачены.')) location.href='all_pay.php';
}else location.href='all_pay.php';" />


</form>
<script type="text/javascript">
$(function(){
	function roundPlus(x, n) { //x - число, n - количество знаков
			  if(isNaN(x) || isNaN(n)) return false;
			  var m = Math.pow(10,n);
			  return Math.round(x*m)/m;
			}
	function CheckSumm(){
		var res=true;
		
		//проверка дат
		
		
		if(!PeriodChecker('given_pdate', '%{$pch_date}%')){
			alert("Заданная дата должна быть не ранее %{$pch_date}%!");
			res=res&&false;
			return false;
		}
		
		if(!PeriodCheckerByPeriod('given_pdate', closed_date )){
			alert('Заданная дата не должна попадать в закрытый период '+interval_string+'!');
			res=res&&false;
			return false;	
		}
		
	
		
		
		//добавить проверки на утверждение
		if($("#is_confirmed").prop("checked")&&("%{$ship.is_confirmed}%"=="0")){
			
			
			//проверка заданных дат
			if(($("#given_pdate").val()=='-')||($("#given_pdate").val()=='')||($("#given_pdate").val().length<10)){
				alert("Для утверждения исходящей оплаты необходимо заполнить заданную дату!");
				$("#given_pdate").focus(); //trigger("click");
				res=res&&false;
				return false;		
			}else{
				now=new Date();
				//check_date=new Date();
				
				now=new Date();
				check_date=new Date($("#given_pdate").val().substring(6,10), $("#given_pdate").val().substring(3,5)-1, $("#given_pdate").val().substring(0,2), 0,0,0,0 );
				
				
				
				if(check_date>now){
					alert("Невозможно утвердить исходящую оплату. Заданная дата превышает текущую!");
					$("#given_pdate").focus(); //trigger("click");
					res=res&&false;
					return false;	
				}
			}
			
			//проверка заданного номера
			if(($("#given_no").val()=='-')||($("#given_no").val()=='')){
				alert("Для утверждения исходящей оплаты необходимо заполнить заданный номер!");
				$("#given_no").focus(); //trigger("click");
				res=res&&false;
				return false;		
			}
			
			
			
			if(($("#supplier_id").val()!=$("#org_id").val())&&($("#is_return").prop("checked")==false)&&($("#is_inner_pay").prop("checked")==false)){
			  //проверка отмеченности галочек
			  if(($("#pay_for_dogovor").prop("checked")==false)&&($("#pay_for_bill").prop("checked")==false)){
				  alert("Для утверждения  исходящей оплаты необходимо выбрать либо оплату по договору, либо оплату по счету!");
				  res=res&&false;
				  return false;		
			  }
			
			}
			
			
			
			//проверка увязки общей суммы с суммой по счетам
			var vv=0.0;
			$.each($("#bill_positions_table tbody tr input[id^=new_hash_]"), function(k,v){
				//alert(v);
				hash=v.value;
				vv=vv+parseFloat($("#new_value_"+hash).val().replace("\,","\."));
				
			});
			
			
			if(roundPlus(parseFloat($("#value").val().replace("\,","\.")),2)<roundPlus(vv,2)){
				
				//alert(parseFloat($("#value").val())+' '+vv);
				alert('Внимание! Сумма платежей по выбранным счетам превышает заданную Вами сумму платежа. Просьба исправить суммы.');
				res=res&&false;
				return false;
			}
			
			if(parseFloat($("#value").val().replace("\,","\."))<=0){
				alert('Внимание! Вы задали нулевую сумму оплаты. Просьба исправить сумму.');
				res=res&&false;
				return false;	
			}
			
		/*	if(($("#supplier_id").val()!=$("#org_id").val())&&($("#is_return").prop("checked")==false)){
				if(($("#contract_id").val()=="")||($("#contract_id").val()==0)||($("#contract_id").val()==undefined)){
			alert('Выберите договор контрагента!');
			  res=res&&false;
				  return false;		
		}	
			}*/
			
		}
		
		if(!$("#is_confirmed").prop("checked")&&("%{$ship.is_confirmed}%"=="1")){
			$.ajax({
				async: false,
				url: "/js/pay.php",
				type: "POST",
				data:{
					"action":"check_unconfirm",
					"id": "%{$ship.id}%"
				},
				beforeSend: function(){
					  
				},
				success: function(data){
				  if(data!=0){
					 
					 alert("Невозможно снять утверждение исходящей оплаты. Причина: "+data+"."); 
					 res=false;
				  }else{
					 res=res&&true;
				  }
				},
				error: function(xhr, status){
					
					alert("Ошибка при проверке состояния исходящей оплаты. Пожалуйста, попытайтесь сохранить оплату снова.");
					res=false;	
				}	 
			});
			
			
			
		
		}
		
		
		
		
		return res;
	}
	
	$("#doEdit").bind("click",function(){
		return CheckSumm();
	});
	$("#doEditStay").bind("click",function(){
		return CheckSumm();
	});
	
});
</script>
<script type="text/javascript">
var frmvalidator  = new Validator("crea_form");




function CheckSupplier(){
	ret=true;
	if(($("#supplier_id").val()=="")||($("#supplier_id").val()==0)||($("#supplier_id").val()==undefined)){
		ret=ret&&false;
		alert("Выберите контрагента!");
	}
	
	if(ret&&(($("#bdetails_id").val()=="")||($("#bdetails_id").val()==0)||($("#bdetails_id").val()==undefined))){
		ret=ret&&false;
		alert("Выберите реквизиты контрагента!");
	}
	
	
	if(ret&&($("#supplier_id").val()!=$("#org_id").val())&&($("#is_return").prop("checked")==false)&&($("#is_inner_pay").prop("checked")==false)){
		if(($("#contract_id").val()=="")||($("#contract_id").val()==0)||($("#contract_id").val()==undefined)){
			alert('Выберите договор контрагента!');
			ret=ret&&false;
		}
	}
	
	
	
	return ret;	
}

function DoCustomValidation()
{
 
	
 
	if($("#is_inner_pay").prop("checked")){
		//либо пол-ль, либо к-т	
		ret_user=true; ret_supplier=true;
		
		if(($("#code_id").val()!=12) &&  (($("#inner_user_id").val()=="")||($("#inner_user_id").val()==0)||($("#inner_user_id").val()==undefined))){
			ret_user=false;	
			ret_supplier=CheckSupplier();	
		}else{
			
		}
		if(!ret_user&&!ret_supplier){
			alert("Выберите или контрагента, или сотрудника-получателя.");	
		}
		
		ret_total=ret_user||ret_supplier;
		if(!ret_total){
			return false;	
		}
		
	}else{
		if(!CheckSupplier()) return false;
		
		
	}
	
	return true;
}





/*frmvalidator.addValidation("supplier_id","req","Выберите контрагента!");
frmvalidator.addValidation("supplier_id","gt=0","Выберите контрагента!");


frmvalidator.addValidation("bdetails_id","req","Выберите реквизиты контрагента!");
frmvalidator.addValidation("bdetails_id","gt=0","Выберите реквизиты контрагента!");
*/


frmvalidator.addValidation("org_bdetails_id","req","Выберите реквизиты организации!");


frmvalidator.addValidation("org_bdetails_id","gt=0","Выберите реквизиты организации!");

frmvalidator.addValidation("code_id","req","Выберите код исходящей оплаты!");
frmvalidator.addValidation("code_id","gt=0","Выберите код исходящей оплаты!");

frmvalidator.setAddnlValidationFunction(DoCustomValidation);

</script>
