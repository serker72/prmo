

<td width="100" %{if $items[rowsec].is_confirmed==0  and $items[rowsec].status_id!=6}%class="item_inactive"%{/if}% id="status_button_%{$items[rowsec].id}%">


%{if $item.status_id==6}%
   
    %{if $can_restore}%
    <input type="button" value="Восстановить" id="deaunnul_%{$item.id}%" />
    %{/if}%
%{elseif  $item.status_id==4}%
  
    %{if $can_confirm}%
    <input type="button" value="Утвердить" id="confirm_%{$item.id}%" />
    %{/if}% 
    %{else}%
 
    %{if   $item.can_unconfirm }%
    <input type="button" value="Не утвердить" id="confirm_%{$item.id}%" />
    %{/if}% 
%{/if}%
    <br />

    %{$item.confirmed_price_name}%  %{$item.confirm_pdate}%
    
    
    <script type="text/javascript">
	$(function(){
		%{if $can_confirm or $can_super_confirm}%
		$("#confirm_%{$item.id}%").bind("click",function(){
			
			%{if $item.is_confirmed==0}%
			//alert("Невозможно утвердить реализацию. Причина: %{$item.can_confirm_reason}%.");
			
			
			var can_ret=true;
			$.ajax({
				async: false,
				url: "/js/%{$filename}%",
				type: "POST",
				data:{
					"action":"check_confirm",
					"id": "%{$item.id}%"
				},
				beforeSend: function(){
					  
				},
				success: function(data){
				 // alert(data);
				  if(data!=0){
					 
					 alert("Невозможно утвердить реализацию. Причина:\n"+data+""); 
					 can_ret=false;
				  }
				},
				error: function(xhr, status){
					
					alert("Ошибка при проверке состояния реализации. Пожалуйста, попытайтесь утвердить реализацию снова.");
					can_ret=false;	
				}	 
			});
			
			
			if(can_ret) $.ajax({
				async: false,
				url: "/js/acc.php",
				type: "POST",
				data:{
					"action":"check_accs_by_given_pdate",
					"supplier_id": "%{$item.supplier_id}%",
					"given_pdate": "%{$item.given_pdate}%"
				},
				beforeSend: function(){
					  
				},
				success: function(data){
				  
				  if(data!=0){
					 
					 //alert("Невозможно утвердить реализацию. Причина: "+data+"."); 
					// can_ret=false;
					 can_ret=window.confirm("Внимание!\По данному контрагенту есть более поздние реализации №№ "+data+".\nПри утверждении реализации входящие оплаты будут перераспределены в счетах-фактурах данной реализации и реализаций №№ "+data+".\nВы уверены?");
				  } 
				},
				error: function(xhr, status){
					
					alert("Ошибка при проверке состояния реализации. Пожалуйста, попытайтесь сохранить реализацию снова.");
					can_ret=false;	
				}	 
			})
			//если все в порядке - то делать... иначе
			
			
			//выводить предупреждающие сообщения о возможности/невозможности снять утв-ие пост-ия после утверждения
			%{if $item.bill_has_pms and $item.inventory_id==0 and $item.cannot_unconfirm}%
			//подтверждение утверждения поступления...
			
			 if(can_ret) if(window.confirm("ВНИМАНИЕ! ВЫ УТВЕРДИЛИ РЕАЛИЗАЦИЮ! У ВАС НЕТ ПРАВА СНЯТЬ УТВЕРЖДЕНИЕ ДАННОЙ РЕАЛИЗАЦИИ!\nСнять утверждение с реализации имеют право следующие сотрудники: %{$item.can_unconfirm_users}%.\nПожалуйста, проверьте корректность внесенных данных.\nВы уверены, что стоит утвердить реализацию?")){
				  if(window.confirm("Вы уверены, что данные внесены корректно и нужно утвердить реализацию?")){
					  
				  }else{
					  can_ret=can_ret&&false;
					  $("#is_confirmed").prop("checked", false);
					  
					  //запись в журнал событий
					  $.ajax({
						async: true,
						url: "/js/%{$filename}%",
						type: "POST",
						data:{
							"action":"refuse_to_confirm",
							id: "%{$item.id}%",
							refuse: "2"
						},
						success: function(data){
						  
						}
					});
					  
					  
				  }
	  
			  }else{
				  can_ret=can_ret&&false;
				  $("#is_confirmed").prop("checked", false);
				  
				  //запись в журнал событий
				  $.ajax({
						async: true,
						url: "/js/%{$filename}%",
						type: "POST",
						data:{
							"action":"refuse_to_confirm",
							id: "%{$item.id}%",
							refuse: "1"
						},
						success: function(data){
						  
						}
				   });
			  }
			
			%{/if}%
			
			if(can_ret==false) return can_ret;
			
			%{elseif $item.is_confirmed==1}%
			var can_ret=true;
			$.ajax({
				async: false,
				url: "/js/%{$filename}%",
				type: "POST",
				data:{
					"action":"check_unconfirm",
					"id": "%{$item.id}%"
				},
				beforeSend: function(){
					  
				},
				success: function(data){
				  if(data!=0){
					 
					 alert("Невозможно снять утверждение реализации. Причина:\n"+data+""); 
					 can_ret=can_ret&&false;
				  }
				},
				error: function(xhr, status){
					
					alert("Ошибка при проверке состояния реализации. Пожалуйста, попытайтесь утвердить реализацию снова.");
					can_ret=can_ret&&false;	
				}	 
			});
			
			
			//выполнить проверку наличия связанных реализаций
			$.ajax({
				async: false,
				url: "/js/%{$filename}%",
				type: "POST",
				data:{
					"action":"check_unconfirm_binded_docs",
					"id": "%{$item.id}%"
				},
				beforeSend: function(){
					  
				},
				success: function(data){
				  if(data!=0){
					 can_ret=can_ret&&window.confirm("Внимание!\nС данной реализацией связаны следующие документы:"+data+"\nСнятие утверждения реализации приведет к автоматическому снятию утверждения документов.\nПродолжить?");
					
					
				  }else can_ret=can_ret&&true;
				},
				error: function(xhr, status){
					
					alert("Ошибка при проверке состояния поступления. Пожалуйста, попытайтесь утвердить поступление снова.");
					can_ret=false;	
				}	 
			});
			
			
			//если все в порядке - то делать... иначе
			
			
			if(can_ret==false) return can_ret;
			%{/if}%
			
			$.ajax({
			  async: true,
			  url: "/js/%{$filename}%",
			  type: "POST",
			  data:{
				  "action":"toggle_confirm",
				  "id":"%{$item.id}%",
				  "shorter":"%{$shorter}%"
			  },
			  beforeSend: function(){
					$("#item_row_%{$items[rowsec].id}%").html('<td colspan="15"><img src="/img/wait.gif" width="32" height="32" alt=""></td>');
			  },
			  success: function(data){
				 $("#item_row_%{$items[rowsec].id}%").html(data);
				
			  },
			  error: function(xhr, status){
				//  alert("Ошибка добавления %{$named}%.");	
			  }	 
		  });
		});
		
		%{/if}%
		
		 %{if $item.status_id==6 and $can_restore}%
		  $("#deaunnul_%{$items[rowsec].id}%").bind("click",function(){
				  $.ajax({
					async: true,
					url: "/js/%{$filename}%",
					type: "POST",
					data:{
						"action":"toggle_annul",
						"id":"%{$items[rowsec].id}%",
						"shorter":"%{$shorter}%"
					},
					beforeSend: function(){
						  $("#item_row_%{$items[rowsec].id}%").html('<td colspan="15"><img src="/img/wait.gif" width="32" height="32" alt=""></td>');
					},
					success: function(data){
					   $("#item_row_%{$items[rowsec].id}%").html(data);
					  
					},
					error: function(xhr, status){
					  //  alert("Ошибка добавления %{$named}%.");	
					}	 
				});
		  });
		  %{/if}%
		
	});
	</script>
    
    
    </td> 
    
    
    